@page "/profile"
@using SportsBettingAnalyzer.Services
@inject PythonMLServiceClient MLClient
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Player/Driver Profiles</MudText>

    <MudGrid>
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-4">
                <!-- Sport Selection -->
                <MudSelect T="string" Label="Select Sport" @bind-Value="_selectedSport" SelectedValuesChanged="OnSportChanged" Variant="Variant.Outlined" Class="mb-4">
                    <MudSelectItem Value="@("nascar")">NASCAR</MudSelectItem>
                    <MudSelectItem Value="@("nfl")">NFL</MudSelectItem>
                </MudSelect>

                @if (_selectedSport == "nascar")
                {
                    <!-- Series Selection -->
                    <MudSelect T="string" Label="Select Series" @bind-Value="SelectedSeries" Variant="Variant.Outlined" Class="mb-4" Disabled="@_isLoadingSeries">
                        <MudSelectItem Value="@("cup")">Cup Series</MudSelectItem>
                        <MudSelectItem Value="@("xfinity")">Xfinity Series</MudSelectItem>
                        <MudSelectItem Value="@("truck")">Truck Series</MudSelectItem>
                    </MudSelect>

                    <!-- Team Selection -->
                    <MudSelect T="string" Label="Select Team" @bind-Value="SelectedTeam" Variant="Variant.Outlined" Class="mb-4" 
                               Disabled="@(string.IsNullOrEmpty(_selectedSeries) || _isLoadingTeams)">
                        @foreach (var team in _teams)
                        {
                            <MudSelectItem Value="@team">@team</MudSelectItem>
                        }
                    </MudSelect>

                    <!-- Driver Selection -->
                    <MudSelect T="string" Label="Select Driver" @bind-Value="SelectedEntity" Variant="Variant.Outlined" Class="mb-4" 
                               Disabled="@(string.IsNullOrEmpty(_selectedTeam) || _isLoadingDrivers)">
                        @foreach (var driver in _drivers)
                        {
                            <MudSelectItem Value="@driver">@driver</MudSelectItem>
                        }
                    </MudSelect>

                    <!-- Year Selection -->
                    @if (!string.IsNullOrEmpty(_selectedEntity) && _availableYears.Any())
                    {
                        <MudSelect T="int?" Label="Select Year" @bind-Value="SelectedYear" Variant="Variant.Outlined" Class="mb-4" Clearable="true">
                            @foreach (var year in _availableYears)
                            {
                                <MudSelectItem Value="@((int?)year)">@year</MudSelectItem>
                            }
                        </MudSelect>
                    }
                }
                else
                {
                    <!-- Fallback for other sports (e.g. NFL) -->
                    <MudAutocomplete T="string" Label="Search Entity" @bind-Value="SelectedEntity"
                                     SearchFunc="@SearchEntities"
                                     ResetValueOnEmptyText="true"
                                     CoerceText="true"
                                     CoerceValue="true"
                                     AdornmentIcon="@Icons.Material.Filled.Search"
                                     AdornmentColor="Color.Primary"
                                     Class="mt-4" />
                }
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="8">
            @if (_profileData != null)
            {
                <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
                    <MudTabPanel Text="Overview">
                        <MudPaper Class="pa-4" Elevation="0">
                            <MudText Typo="Typo.h5">@_selectedEntity</MudText>
                            <MudText Typo="Typo.subtitle1" Color="Color.Secondary">@_selectedTeam</MudText>
                            <MudDivider Class="my-2" />

                            <!-- Stats Grid -->
                            <MudGrid>
                                @foreach (var stat in _profileData.Stats)
                                {
                                    <MudItem xs="6" sm="4" md="3">
                                        <MudPaper Class="pa-3" Elevation="2">
                                            <MudText Typo="Typo.caption">@stat.Key</MudText>
                                            <MudText Typo="Typo.h6">@stat.Value</MudText>
                                        </MudPaper>
                                    </MudItem>
                                }
                            </MudGrid>

                            <!-- Splits -->
                            @if (_profileData.Splits.Any())
                            {
                                <MudText Typo="Typo.h6" Class="mt-4">Splits</MudText>
                                <MudTable Items="@_profileData.Splits" Dense="true" Hover="true" Class="mt-2">
                                    <HeaderContent>
                                        <MudTh>Category</MudTh>
                                        @foreach (var key in _profileData.Splits.First().Value.Keys)
                                        {
                                            <MudTh>@key</MudTh>
                                        }
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd DataLabel="Category">@context.Key</MudTd>
                                        @foreach (var val in context.Value.Values)
                                        {
                                            <MudTd>@val</MudTd>
                                        }
                                    </RowTemplate>
                                </MudTable>
                            }

                            <!-- History -->
                            @if (_profileData.History.Any())
                            {
                                <MudText Typo="Typo.h6" Class="mt-4">Recent History (2012+)</MudText>
                                <MudTable Items="@_profileData.History" Dense="true" Hover="true" Class="mt-2" 
                                          SortLabel="Sort By" Filter="new Func<Dictionary<string, object>,bool>(FilterHistory)"
                                          Striped="true" Bordered="true">
                                    <ToolBarContent>
                                        <MudText Typo="Typo.h6">Race History</MudText>
                                        <MudSpacer />
                                        <MudTextField @bind-Value="_historySearchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                                    </ToolBarContent>
                                    <HeaderContent>
                                        @foreach (var key in _profileData.History.First().Keys)
                                        {
                                            <MudTh><MudTableSortLabel SortBy="new Func<Dictionary<string, object>, object>(x => x[key])">@key</MudTableSortLabel></MudTh>
                                        }
                                    </HeaderContent>
                                    <RowTemplate>
                                        @foreach (var val in context.Values)
                                        {
                                            <MudTd>@val</MudTd>
                                        }
                                    </RowTemplate>
                                    <PagerContent>
                                        <MudTablePager />
                                    </PagerContent>
                                </MudTable>
                            }
                        </MudPaper>
                    </MudTabPanel>
                    
                    <MudTabPanel Text="Comparison">
                        <MudGrid>
                            <!-- Year A Selection -->
                            <MudItem xs="6">
                                <MudSelect T="int?" Label="Year A" @bind-Value="CompYearA" Variant="Variant.Outlined" Clearable="true">
                                    @foreach (var year in _availableYears)
                                    {
                                        <MudSelectItem Value="@((int?)year)">@year</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                            
                            <!-- Year B Selection -->
                            <MudItem xs="6">
                                <MudSelect T="int?" Label="Year B" @bind-Value="CompYearB" Variant="Variant.Outlined" Clearable="true">
                                    @foreach (var year in _availableYears)
                                    {
                                        <MudSelectItem Value="@((int?)year)">@year</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                        </MudGrid>
                        
                        <MudGrid Class="mt-4">
                            <MudItem xs="12">
                                @if (_isLoadingCompA || _isLoadingCompB)
                                {
                                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="mx-auto d-block" />
                                }
                                else if (_compDataA != null && _compDataB != null)
                                {
                                    <MudTable Items="@GetComparisonStats(_compDataA, _compDataB)" Dense="true" Hover="true" Striped="true">
                                        <HeaderContent>
                                            <MudTh>Stat</MudTh>
                                            <MudTh>@_compYearA</MudTh>
                                            <MudTh>Diff</MudTh>
                                            <MudTh>@_compYearB</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd DataLabel="Stat"><b>@context.Name</b></MudTd>
                                            <MudTd DataLabel="@_compYearA.ToString()">@context.ValueA</MudTd>
                                            <MudTd DataLabel="Diff">
                                                @if (context.IsBetterA)
                                                {
                                                    <MudText Color="Color.Success" Typo="Typo.body2"><b>@context.Diff</b></MudText>
                                                }
                                                else if (context.IsBetterB)
                                                {
                                                    <MudText Color="Color.Error" Typo="Typo.body2"><b>@context.Diff</b></MudText>
                                                }
                                                else
                                                {
                                                    <MudText Color="Color.Default" Typo="Typo.body2">@context.Diff</MudText>
                                                }
                                            </MudTd>
                                            <MudTd DataLabel="@_compYearB.ToString()">@context.ValueB</MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                    
                                    @if (_compDataA.Splits.Any() && _compDataB.Splits.Any())
                                    {
                                        <MudText Typo="Typo.h6" Class="mt-6 mb-2">Track Type Splits</MudText>
                                        <MudGrid>
                                            <MudItem xs="6">
                                                <MudPaper Class="pa-3">
                                                    <MudText Typo="Typo.subtitle2" Align="Align.Center">@_compYearA</MudText>
                                                    @foreach(var split in _compDataA.Splits)
                                                    {
                                                        <MudText Typo="Typo.caption"><b>@split.Key:</b> Avg @split.Value["Avg Finish"]</MudText><br/>
                                                    }
                                                </MudPaper>
                                            </MudItem>
                                            <MudItem xs="6">
                                                <MudPaper Class="pa-3">
                                                    <MudText Typo="Typo.subtitle2" Align="Align.Center">@_compYearB</MudText>
                                                    @foreach(var split in _compDataB.Splits)
                                                    {
                                                        <MudText Typo="Typo.caption"><b>@split.Key:</b> Avg @split.Value["Avg Finish"]</MudText><br/>
                                                    }
                                                </MudPaper>
                                            </MudItem>
                                        </MudGrid>
                                    }
                                }
                            </MudItem>
                        </MudGrid>
                    </MudTabPanel>
                </MudTabs>
            }
            else if (!string.IsNullOrEmpty(_selectedEntity) && _isLoading)
            {
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            }
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private string _selectedSport = "nascar";
    private string _selectedSeries;
    private string _selectedTeam;
    private string _selectedEntity;
    private int? _selectedYear;
    
    // Comparison vars
    private int? _compYearA;
    private int? _compYearB;
    private ProfileData _compDataA;
    private ProfileData _compDataB;
    private bool _isLoadingCompA = false;
    private bool _isLoadingCompB = false;

    private List<string> _teams = new();
    private List<string> _drivers = new();
    private List<string> _entities = new(); // Fallback for non-NASCAR
    private List<int> _availableYears = new();
    
    private ProfileData _profileData;
    
    private bool _isLoading = false;
    private bool _isLoadingSeries = false;
    private bool _isLoadingTeams = false;
    private bool _isLoadingDrivers = false;

    private string SelectedEntity
    {
        get => _selectedEntity;
        set
        {
            if (_selectedEntity != value)
            {
                _selectedEntity = value;
                if (!string.IsNullOrEmpty(value))
                {
                    _selectedYear = null; // Reset year when driver changes
                    _compYearA = null;
                    _compYearB = null;
                    _compDataA = null;
                    _compDataB = null;
                    _ = LoadProfile();
                }
            }
        }
    }
    
    private int? SelectedYear
    {
        get => _selectedYear;
        set
        {
            if (_selectedYear != value)
            {
                _selectedYear = value;
                if (!string.IsNullOrEmpty(_selectedEntity))
                {
                    _ = LoadProfile();
                }
            }
        }
    }
    
    private int? CompYearA
    {
        get => _compYearA;
        set
        {
            if (_compYearA != value)
            {
                _compYearA = value;
                if (value.HasValue && !string.IsNullOrEmpty(_selectedEntity))
                    _ = LoadCompProfile(value.Value, true);
                else
                    _compDataA = null;
            }
        }
    }

    private int? CompYearB
    {
        get => _compYearB;
        set
        {
            if (_compYearB != value)
            {
                _compYearB = value;
                if (value.HasValue && !string.IsNullOrEmpty(_selectedEntity))
                    _ = LoadCompProfile(value.Value, false);
                else
                    _compDataB = null;
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        if (_selectedSport != "nascar")
        {
            await LoadEntities();
        }
    }

    private async Task OnSportChanged()
    {
        _selectedSeries = null;
        _selectedTeam = null;
        _selectedEntity = null;
        _selectedYear = null;
        _profileData = null;
        _compDataA = null;
        _compDataB = null;
        _teams.Clear();
        _drivers.Clear();
        _availableYears.Clear();
        
        if (_selectedSport != "nascar")
        {
            await LoadEntities();
        }
    }

    private string SelectedSeries
    {
        get => _selectedSeries;
        set
        {
            if (_selectedSeries != value)
            {
                _selectedSeries = value;
                _selectedTeam = null;
                _selectedEntity = null;
                _selectedYear = null;
                _profileData = null;
                _teams.Clear();
                _drivers.Clear();
                _availableYears.Clear();
                
                if (!string.IsNullOrEmpty(value))
                {
                    _ = LoadTeams();
                }
            }
        }
    }

    private string SelectedTeam
    {
        get => _selectedTeam;
        set
        {
            if (_selectedTeam != value)
            {
                _selectedTeam = value;
                _selectedEntity = null;
                _selectedYear = null;
                _profileData = null;
                _drivers.Clear();
                _availableYears.Clear();

                if (!string.IsNullOrEmpty(value))
                {
                    _ = LoadDrivers();
                }
            }
        }
    }

    private async Task LoadTeams()
    {
        _isLoadingTeams = true;
        try
        {
            _teams = await MLClient.GetTeamsAsync(_selectedSport, _selectedSeries);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading teams: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoadingTeams = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task LoadDrivers()
    {
        _isLoadingDrivers = true;
        try
        {
            _drivers = await MLClient.GetDriversAsync(_selectedSport, _selectedSeries, _selectedTeam);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading drivers: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoadingDrivers = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    // Fallback for non-NASCAR
    private async Task LoadEntities()
    {
        try
        {
            _entities = await MLClient.GetEntitiesAsync(_selectedSport);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading entities: {ex.Message}", Severity.Error);
        }
    }

    private async Task<IEnumerable<string>> SearchEntities(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value))
            return _entities;
        return _entities.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }

    private async Task<IEnumerable<string>> SearchTeams(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value))
            return _teams;
        return _teams.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }

    private async Task<IEnumerable<string>> SearchDrivers(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value))
            return _drivers;
        return _drivers.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }

    private string _historySearchString = "";

    private bool FilterHistory(Dictionary<string, object> element)
    {
        if (string.IsNullOrWhiteSpace(_historySearchString))
            return true;
            
        foreach (var val in element.Values)
        {
            if (val?.ToString()?.Contains(_historySearchString, StringComparison.OrdinalIgnoreCase) == true)
                return true;
        }
        return false;
    }

    private async Task LoadProfile()
    {
        _isLoading = true;
        try
        {
            // Pass series if available, though backend might not strictly need it for ID lookup
            _profileData = await MLClient.GetEntityProfileAsync(_selectedSport, _selectedEntity, _selectedSeries, _selectedYear);
            
            // Update available years if returned
            if (_profileData.Years != null && _profileData.Years.Any())
            {
                _availableYears = _profileData.Years;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading profile: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }
    
    private async Task LoadCompProfile(int year, bool isA)
    {
        if (isA) _isLoadingCompA = true;
        else _isLoadingCompB = true;
        
        try
        {
            var data = await MLClient.GetEntityProfileAsync(_selectedSport, _selectedEntity, _selectedSeries, year);
            if (isA) _compDataA = data;
            else _compDataB = data;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading comparison profile: {ex.Message}", Severity.Error);
        }
        finally
        {
            if (isA) _isLoadingCompA = false;
            else _isLoadingCompB = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    public class ComparisonRow
    {
        public string Name { get; set; }
        public string ValueA { get; set; }
        public string ValueB { get; set; }
        public string Diff { get; set; }
        public bool IsBetterA { get; set; }
        public bool IsBetterB { get; set; }
    }

    private List<ComparisonRow> GetComparisonStats(ProfileData a, ProfileData b)
    {
        var rows = new List<ComparisonRow>();
        
        // Helper to parse and compare
        void AddRow(string name, string key, bool lowerIsBetter = false)
        {
            if (a.Stats.TryGetValue(key, out var valA) && b.Stats.TryGetValue(key, out var valB))
            {
                var row = new ComparisonRow { Name = name, ValueA = valA.ToString(), ValueB = valB.ToString() };
                
                // Try numeric comparison
                if (double.TryParse(valA.ToString().Replace("%", ""), out var numA) && 
                    double.TryParse(valB.ToString().Replace("%", ""), out var numB))
                {
                    var diff = numA - numB;
                    row.Diff = diff > 0 ? $"+{diff:0.##}" : $"{diff:0.##}";
                    
                    if (Math.Abs(diff) < 0.01)
                    {
                        row.Diff = "-";
                    }
                    else if (lowerIsBetter)
                    {
                        row.IsBetterA = numA < numB;
                        row.IsBetterB = numB < numA;
                    }
                    else
                    {
                        row.IsBetterA = numA > numB;
                        row.IsBetterB = numB > numA;
                    }
                    
                    if (key.Contains("%")) row.Diff += "%";
                }
                else
                {
                    row.Diff = "-";
                }
                
                rows.Add(row);
            }
        }

        AddRow("Races", "Races");
        AddRow("Wins", "Wins");
        AddRow("Top 5", "Top 5");
        AddRow("Top 10", "Top 10");
        AddRow("Poles", "Poles");
        AddRow("Laps Led", "Laps Led");
        AddRow("DNFs", "DNFs", lowerIsBetter: true);
        AddRow("Avg Start", "Avg Start", lowerIsBetter: true);
        AddRow("Avg Finish", "Avg Finish", lowerIsBetter: true);
        AddRow("Win %", "Win %");

        return rows;
    }
}
