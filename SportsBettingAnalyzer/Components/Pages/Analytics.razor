@page "/analytics"
@using MudBlazor
@using SportsBettingAnalyzer.Services
@inject DataCollectionService DataCollectionService
@rendermode InteractiveServer

<PageTitle>Analytics</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">Betting Analytics</MudText>
<MudText Typo="Typo.body1" GutterBottom="true" Class="mb-4">
    View statistics and performance metrics for your betting history.
</MudText>

@if (_isLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}

@if (_analytics != null && _analytics.Any())
{
    <MudGrid>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudText Typo="Typo.h6">Total Bets</MudText>
                    <MudText Typo="Typo.h4">@_analytics["TotalBets"]</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudText Typo="Typo.h6">Bets with Results</MudText>
                    <MudText Typo="Typo.h4">@_analytics["BetsWithResults"]</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudText Typo="Typo.h6">Win Rate</MudText>
                    <MudText Typo="Typo.h4" Color="@(GetWinRateColor())">
                        @(((double)_analytics["WinRate"] * 100).ToString("F1"))%
                    </MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudText Typo="Typo.h6">Won Bets</MudText>
                    <MudText Typo="Typo.h4" Color="Color.Success">@_analytics["WonBets"]</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudText Typo="Typo.h6">Total Wagered</MudText>
                    <MudText Typo="Typo.h4">$@(((decimal)_analytics["TotalWagered"]).ToString("F2"))</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudText Typo="Typo.h6">Total Payout</MudText>
                    <MudText Typo="Typo.h4" Color="Color.Success">
                        $@(((decimal)_analytics["TotalPayout"]).ToString("F2"))
                    </MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudText Typo="Typo.h6">Net Profit/Loss</MudText>
                    <MudText Typo="Typo.h4" Color="@(GetProfitColor())">
                        $@(((decimal)_analytics["NetProfit"]).ToString("F2"))
                    </MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="6">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudText Typo="Typo.h6">Good Bet Recommendations</MudText>
                    <MudText Typo="Typo.h4" Color="Color.Success">@_analytics["GoodBetCount"]</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
}
else if (!_isLoading)
{
    <MudAlert Severity="Severity.Info">No analytics data available. Analyze some bets and record results to see statistics.</MudAlert>
}

@code {
    private Dictionary<string, object>? _analytics;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadAnalytics();
    }

    private async Task LoadAnalytics()
    {
        try
        {
            _isLoading = true;
            _analytics = await DataCollectionService.GetAnalyticsAsync();
        }
        catch (Exception ex)
        {
            // Handle error
        }
        finally
        {
            _isLoading = false;
        }
    }

    private Color GetWinRateColor()
    {
        if (_analytics == null || !_analytics.ContainsKey("WinRate"))
            return Color.Default;
        
        var winRate = (double)_analytics["WinRate"];
        return winRate >= 0.5 ? Color.Success : winRate >= 0.4 ? Color.Warning : Color.Error;
    }

    private Color GetProfitColor()
    {
        if (_analytics == null || !_analytics.ContainsKey("NetProfit"))
            return Color.Default;
        
        var profit = (decimal)_analytics["NetProfit"];
        return profit >= 0 ? Color.Success : Color.Error;
    }
}

