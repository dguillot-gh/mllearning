@page "/testfetch"
@rendermode InteractiveServer
@using SportsBettingAnalyzer.Services
@inject ExternalDataManager DataManager
@inject ILogger<TestFetch> Logger

<PageTitle>Test Data Fetching</PageTitle>

<div class="container mt-5">
    <h2>Test External Data Fetching</h2>

    <button class="btn btn-primary btn-lg mt-3" @onclick="FetchNFLData" disabled="@_isFetching">
        @if (_isFetching)
        {
            <span class="spinner-border spinner-border-sm"></span>
            <span> Fetching...</span>
        }
        else
        {
            <span>Fetch NFL Games</span>
        }
    </button>

    @if (_result != null)
    {
        <div class="alert alert-@(_result.Success ? "success" : "danger") mt-3">
            <strong>@_result.Message</strong>
            <p>Games fetched: @_result.Count</p>
        </div>
    }
</div>

@code {
    private bool _isFetching = false;
    private FetchResult? _result;

    private async Task FetchNFLData()
    {
        Logger.LogInformation("===== FETCH BUTTON CLICKED =====");
        try
        {
            _isFetching = true;
            StateHasChanged();

            Logger.LogInformation("Calling DataManager.FetchHistoricalGamesAsync");

            var games = await DataManager.FetchHistoricalGamesAsync(
                sport: "NFL",
                startDate: DateTime.Now.AddYears(-1),
                endDate: DateTime.Now,
                preferredProvider: null
            );

            Logger.LogInformation("Received {Count} games", games.Count);

            _result = new FetchResult
            {
                Success = games.Count > 0,
                Message = games.Count > 0 ? "Success!" : "No games found",
                Count = games.Count
            };
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error fetching data");
            _result = new FetchResult
            {
                Success = false,
                Message = $"Error: {ex.Message}",
                Count = 0
            };
        }
        finally
        {
            _isFetching = false;
            StateHasChanged();
        }
    }

    private class FetchResult
    {
        public bool Success { get; set; }
        public string Message { get; set; } = "";
        public int Count { get; set; }
    }
}
