@page "/data"
@using MudBlazor
@using SportsBettingAnalyzer.Services
@using SportsBettingAnalyzer.Data
@using SportsBettingAnalyzer.Models
@using Microsoft.EntityFrameworkCore
@inject ExternalDataManager ExternalData
@inject MLModelService MLModelService
@inject DataCollectionService DataCollectionService
@inject ApplicationDbContext DbContext
@inject ILogger<DataManager> Logger
@rendermode InteractiveServer

<PageTitle>Data Management Center</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">Data Management Center</MudText>
<MudText Typo="Typo.body1" GutterBottom="true" Class="mb-4">
    Professional Sports Betting Analysis Platform - Manage your sports data, import historical games, and train AI models
</MudText>

<!-- Status Cards -->
<MudGrid>
    <MudItem xs="12" sm="6" md="3">
        <MudCard Elevation="2">
 <MudCardContent>
      <MudText Typo="Typo.body2">Total Games</MudText>
            <MudText Typo="Typo.h5">@(_dbStats?.TotalGames ?? 0)</MudText>
         </MudCardContent>
      </MudCard>
    </MudItem>
    <MudItem xs="12" sm="6" md="3">
        <MudCard Elevation="2">
        <MudCardContent>
     <MudText Typo="Typo.body2">Model Status</MudText>
        <MudText Typo="Typo.h5">@(_trainingStats?.IsModelTrained == true ? "Ready" : "Pending")</MudText>
</MudCardContent>
        </MudCard>
    </MudItem>
<MudItem xs="12" sm="6" md="3">
        <MudCard Elevation="2">
            <MudCardContent>
                <MudText Typo="Typo.body2">Training Data</MudText>
      <MudText Typo="Typo.h5">@(_trainingStats?.TotalGames ?? 0)</MudText>
        </MudCardContent>
      </MudCard>
    </MudItem>
    <MudItem xs="12" sm="6" md="3">
        <MudCard Elevation="2">
            <MudCardContent>
       <MudText Typo="Typo.body2">Last Updated</MudText>
          <MudText Typo="Typo.h5">@(DateTime.Now.ToString("HH:mm"))</MudText>
  </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

<!-- Tabs -->
<MudTabs ActivePanelIndex="_activeTab" Class="mt-4">
  <!-- Dashboard Tab -->
    <MudTabPanel Text="Dashboard" Icon="@Icons.Material.Filled.Dashboard">
        <div class="pa-4">
     <MudGrid>
            <MudItem xs="12" sm="6" md="4">
          <MudCard Elevation="2">
          <MudCardContent>
   <MudText Typo="Typo.h6">NFL Games</MudText>
         <MudText Typo="Typo.h4">@_dbStats?.TotalNFL</MudText>
   </MudCardContent>
        </MudCard>
  </MudItem>
         <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="2">
     <MudCardContent>
   <MudText Typo="Typo.h6">NBA Games</MudText>
    <MudText Typo="Typo.h4">@_dbStats?.TotalNBA</MudText>
    </MudCardContent>
       </MudCard>
         </MudItem>
       <MudItem xs="12" sm="6" md="4">
      <MudCard Elevation="2">
        <MudCardContent>
            <MudText Typo="Typo.h6">NASCAR Races</MudText>
         <MudText Typo="Typo.h4">@_dbStats?.TotalNASCAR</MudText>
         </MudCardContent>
   </MudCard>
  </MudItem>
        </MudGrid>

            <MudCard Elevation="2" Class="mt-4">
     <MudCardHeader>
     <MudText Typo="Typo.h6">Quick Actions</MudText>
     </MudCardHeader>
                <MudCardContent>
          <MudStack Row="true" Spacing="2">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" @onclick="@(() => _activeTab = 1)">
          Import CSV
            </MudButton>
         <MudButton Variant="Variant.Filled" Color="Color.Info" @onclick="@(() => _activeTab = 2)">
 Fetch Data
          </MudButton>
   <MudButton Variant="Variant.Filled" Color="Color.Success" @onclick="@(() => _activeTab = 4)">
    Train Model
      </MudButton>
           <MudButton Variant="Variant.Filled" Color="Color.Error" @onclick="ClearDatabase" Disabled="@_isClearingDb">
           @if (_isClearingDb)
         {
     <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
   <MudText Class="ms-2">Clearing...</MudText>
         }
                 else
            {
     <span>Clear All Data</span>
         }
 </MudButton>
       </MudStack>
          </MudCardContent>
        </MudCard>
        </div>
 </MudTabPanel>

<!-- Import Data Tab -->
    <MudTabPanel Text="Import Data" Icon="@Icons.Material.Filled.FileDownload">
        <div class="pa-4">
            <MudGrid>
  <MudItem xs="12" md="6">
          <MudCard Elevation="2">
    <MudCardHeader>
      <MudText Typo="Typo.h6">Supported Datasets</MudText>
           </MudCardHeader>
      <MudCardContent>
<MudText Typo="Typo.body2" Class="mb-2">- NFL: 1966-2024 (10,000+ games)</MudText>
              <MudText Typo="Typo.body2" Class="mb-2">- NBA: 1979-2024 (20,000+ games)</MudText>
       <MudText Typo="Typo.body2">- NASCAR: 1972-2024 (5,000+ races)</MudText>
  </MudCardContent>
     </MudCard>
            </MudItem>

      <MudItem xs="12" md="6">
         <MudCard Elevation="2">
           <MudCardHeader>
       <MudText Typo="Typo.h6">Select File</MudText>
          </MudCardHeader>
            <MudCardContent>
            <InputFile OnChange="@OnFileSelected" accept=".csv" />
       @if (_selectedFile != null)
 {
        <MudAlert Severity="Severity.Success" Class="mt-3">
   <strong>Selected:</strong> @_selectedFile.Name<br />
                 <strong>Size:</strong> @(_selectedFile.Size / 1024)KB
    </MudAlert>
              <MudButton Variant="Variant.Filled" Color="Color.Success" @onclick="ImportKaggleCSV" 
   Disabled="@_isImportingKaggle" FullWidth="true" Class="mt-3">
         @if (_isImportingKaggle)
             {
 <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
         <MudText Class="ms-2">Importing...</MudText>
        }
            else
      {
     <span>Import CSV</span>
        }
      </MudButton>
               }
        </MudCardContent>
  </MudCard>
      </MudItem>
          </MudGrid>

      @if (_kaggleImportResult != null)
            {
           <MudAlert Severity="@(_kaggleImportResult.Success ? Severity.Success : Severity.Error)" Class="mt-3">
               @_kaggleImportResult.Message
          </MudAlert>
     }
        </div>
    </MudTabPanel>

    <!-- Fetch Data Tab -->
    <MudTabPanel Text="Fetch Data" Icon="@Icons.Material.Filled.CloudDownload">
        <div class="pa-4">
         <MudCard Elevation="2">
   <MudCardHeader>
      <MudText Typo="Typo.h6">Fetch Configuration</MudText>
      </MudCardHeader>
        <MudCardContent>
          <MudGrid>
       <MudItem xs="12" md="6">
             <MudTextField @bind-Value="_fetchYear" Label="Season Year" Type="number" 
        Min="2000" Max="2025" />
      </MudItem>
      <MudItem xs="12" md="6">
      <MudSelect @bind-Value="_dataSource" Label="Data Source" Dense="true">
          <MudSelectItem Value="@("WebScraping")">Web Scraping (Free)</MudSelectItem>
       <MudSelectItem Value="@("ESPN")">ESPN API</MudSelectItem>
     </MudSelect>
        </MudItem>
         </MudGrid>

        <MudStack Row="true" Spacing="2" Class="mt-4">
         <MudButton Variant="Variant.Filled" Color="Color.Primary" @onclick="@(() => FetchData("NFL"))" 
          Disabled="@_isFetching">
   @if (_isFetching && _currentSport == "NFL")
{
         <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
   <MudText Class="ms-2">Fetching...</MudText>
             }
   else
{
        <span>Fetch NFL</span>
          }
        </MudButton>
             <MudButton Variant="Variant.Filled" Color="Color.Primary" @onclick="@(() => FetchData("NBA"))" 
     Disabled="@_isFetching">
       @if (_isFetching && _currentSport == "NBA")
    {
     <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
      <MudText Class="ms-2">Fetching...</MudText>
 }
           else
             {
           <span>Fetch NBA</span>
        }
</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" @onclick="@(() => FetchData("NASCAR"))" 
             Disabled="@_isFetching">
           @if (_isFetching && _currentSport == "NASCAR")
  {
      <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
         <MudText Class="ms-2">Fetching...</MudText>
    }
      else
        {
           <span>Fetch NASCAR</span>
     }
        </MudButton>
</MudStack>

                @if (_fetchResult != null)
                {
             <MudAlert Severity="@(_fetchResult.Success ? Severity.Success : Severity.Warning)" Class="mt-3">
      @_fetchResult.Message
  </MudAlert>
   }
    </MudCardContent>
 </MudCard>
     </div>
    </MudTabPanel>

    <!-- Database Tab -->
    <MudTabPanel Text="Database" Icon="@Icons.Material.Filled.Storage">
      <div class="pa-4">
         <MudButton Variant="Variant.Filled" Color="Color.Info" @onclick="LoadDatabaseStats" Disabled="@_isLoadingDb" Class="mb-4">
           @if (_isLoadingDb)
     {
              <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
     <MudText Class="ms-2">Loading...</MudText>
           }
            else
          {
      <span>Refresh</span>
   }
    </MudButton>

       @if (_isLoadingDb)
     {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
  }
    else if (_recentGames.Any())
            {
      <MudTable Items="@_recentGames.Take(20)" Hover="true" Dense="true" Striped="true">
    <HeaderContent>
    <MudTh>Sport</MudTh>
          <MudTh>Date</MudTh>
      <MudTh>Team 1</MudTh>
       <MudTh>Score</MudTh>
  <MudTh>Team 2</MudTh>
        <MudTh>Score</MudTh>
 <MudTh>Winner</MudTh>
          </HeaderContent>
             <RowTemplate>
   <MudTd DataLabel="Sport">
      <MudChip T="string" Size="Size.Small" Color="Color.Primary">@context.Sport</MudChip>
</MudTd>
         <MudTd DataLabel="Date">@context.GameDate.ToString("MM/dd/yyyy")</MudTd>
<MudTd DataLabel="Team 1"><strong>@context.Team1</strong></MudTd>
          <MudTd DataLabel="Score">@context.Team1Score</MudTd>
      <MudTd DataLabel="Team 2"><strong>@context.Team2</strong></MudTd>
     <MudTd DataLabel="Score">@context.Team2Score</MudTd>
      <MudTd DataLabel="Winner">
          @if (context.Team1Won == true)
 {
          <MudChip T="string" Size="Size.Small" Color="Color.Success">@context.Team1</MudChip>
         }
         else if (context.Team1Won == false)
          {
 <MudChip T="string" Size="Size.Small" Color="Color.Success">@context.Team2</MudChip>
       }
            </MudTd>
        </RowTemplate>
     </MudTable>
            }
       else if (!_isLoadingDb)
      {
    <MudAlert Severity="Severity.Info">No games in database. Import or fetch data to get started!</MudAlert>
            }
        </div>
    </MudTabPanel>

    <!-- Train Model Tab -->
    <MudTabPanel Text="Train Model" Icon="@Icons.Material.Filled.AutoAwesome">
        <div class="pa-4">
   <MudCard Elevation="2">
         <MudCardHeader>
          <MudText Typo="Typo.h6">Training Status</MudText>
   </MudCardHeader>
     <MudCardContent>
        <MudGrid>
       <MudItem xs="12" md="6">
         <MudCard Elevation="1">
      <MudCardContent>
              <MudText Typo="Typo.body2">Games Available</MudText>
  <MudText Typo="Typo.h4">@(_trainingStats?.TotalGames ?? 0)</MudText>
           </MudCardContent>
  </MudCard>
                </MudItem>
   </MudGrid>

         @if (_trainingStats?.TotalGames < 10)
             {
           <MudAlert Severity="Severity.Warning" Class="mt-3">
       Need at least 10 games to train. Currently have @(_trainingStats?.TotalGames ?? 0) games.
        </MudAlert>
           }

           <MudButton Variant="Variant.Filled" Color="Color.Success" @onclick="TrainModel" 
           Disabled="@(_isTraining || (_trainingStats?.TotalGames ?? 0) < 10)" 
   FullWidth="true" Class="mt-4">
               @if (_isTraining)
       {
     <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
   <MudText Class="ms-2">Training...</MudText>
      }
        else
              {
       <span>Train Model</span>
      }
          </MudButton>

    @if (_trainingResult != null)
          {
                 <MudAlert Severity="@(_trainingResult.Success ? Severity.Success : Severity.Error)" Class="mt-3">
    @_trainingResult.Message
        </MudAlert>
     }
   </MudCardContent>
            </MudCard>

   <MudCard Elevation="2" Class="mt-4">
        <MudCardHeader>
 <MudText Typo="Typo.h6">Training Information</MudText>
          </MudCardHeader>
    <MudCardContent>
 <MudText Typo="Typo.h6">What is ML Training?</MudText>
     <MudText Typo="Typo.body2" Class="mb-3">The ML model learns patterns from your historical game data to predict future outcomes.</MudText>

     <MudText Typo="Typo.h6" Class="mt-4">Requirements</MudText>
  <MudText Typo="Typo.body2" Class="mb-2">- Minimum 10 games</MudText>
       <MudText Typo="Typo.body2" Class="mb-2">- Complete game data (scores, dates, teams)</MudText>
         <MudText Typo="Typo.body2" Class="mb-3">- Different teams/matchups</MudText>

   <MudText Typo="Typo.h6" Class="mt-4">What Happens During Training</MudText>
<MudText Typo="Typo.body2" Class="mb-2">- Algorithm analyzes historical patterns</MudText>
          <MudText Typo="Typo.body2" Class="mb-2">- Learns team performance trends</MudText>
            <MudText Typo="Typo.body2" Class="mb-2">- Creates predictive model</MudText>
         <MudText Typo="Typo.body2">- Ready for real-time predictions</MudText>
    </MudCardContent>
            </MudCard>
  </div>
    </MudTabPanel>
</MudTabs>

@code {
    private int _activeTab = 0;
    private bool _isFetching = false;
    private bool _isLoadingDb = false;
    private bool _isTraining = false;
    private bool _isClearingDb = false;
    private bool _isImportingKaggle = false;
    private string? _currentSport;
    private FetchResult? _fetchResult;
    private DatabaseStats? _dbStats;
    private List<HistoricalGameResult> _recentGames = new();
    private TrainingStats? _trainingStats;
    private TrainingResult? _trainingResult;
    private int _fetchYear = DateTime.Now.Year - 1;
    private string _dataSource = "WebScraping";
    private IBrowserFile? _selectedFile;
    private ImportResult? _kaggleImportResult;

    protected override async Task OnInitializedAsync()
    {
    await LoadDatabaseStats();
        await LoadTrainingStats();
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        _selectedFile = e.File;
        _kaggleImportResult = null;
        Logger.LogInformation("File selected: {FileName} ({SizeKB}KB)", e.File.Name, e.File.Size / 1024);
    }

    private async Task ImportKaggleCSV()
    {
        if (_selectedFile == null)
        {
            _kaggleImportResult = new ImportResult { Success = false, Message = "Please select a file first" };
    return;
        }

        try
     {
            _isImportingKaggle = true;
      _kaggleImportResult = null;
 StateHasChanged();

       Logger.LogInformation("Starting CSV import from {FileName}", _selectedFile.Name);

 using (var stream = _selectedFile.OpenReadStream(maxAllowedSize: 50_000_000))
       {
           // Legacy Kaggle CSV import removed - use Python ML Service instead
     // This was previously: var importedCount = await KaggleImportService.ImportFromSpreadsokeCSVAsync(stream);
         
    _kaggleImportResult = new ImportResult
      {
        Success = false,
              Message = "CSV import moved to Python ML Service. Use ML Training page instead."
         };
            }
     }
        catch (Exception ex)
    {
      Logger.LogError(ex, "Error during import");
            _kaggleImportResult = new ImportResult
     {
 Success = false,
     Message = $"Import failed: {ex.Message}"
            };
        }
 finally
      {
_isImportingKaggle = false;
     _selectedFile = null;
     StateHasChanged();
  }
    }

  private async Task FetchData(string sport)
    {
        try
        {
 _isFetching = true;
       _currentSport = sport;
      _fetchResult = null;
            StateHasChanged();

            var startDate = new DateTime(_fetchYear, 1, 1);
      var endDate = new DateTime(_fetchYear, 12, 31);

            var games = await ExternalData.FetchHistoricalGamesAsync(
  sport: sport,
 startDate: startDate,
                endDate: endDate,
  preferredProvider: _dataSource
   );

     _fetchResult = new FetchResult
            {
      Success = games.Count > 0,
          Message = games.Count > 0
         ? $"Fetched {games.Count} {sport} games!"
            : $"No {sport} games found for {_fetchYear}",
     Count = games.Count
         };

     if (games.Count > 0)
 {
          await LoadDatabaseStats();
     await LoadTrainingStats();
    }
    }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error fetching {Sport} data", sport);
_fetchResult = new FetchResult
      {
    Success = false,
   Message = $"Error: {ex.Message}",
         Count = 0
         };
     }
        finally
        {
   _isFetching = false;
  _currentSport = null;
      StateHasChanged();
        }
    }

    private async Task LoadDatabaseStats()
    {
        try
  {
_isLoadingDb = true;
        StateHasChanged();

         var allGames = await DbContext.HistoricalGameResults.ToListAsync();

  _dbStats = new DatabaseStats
            {
    TotalNFL = allGames.Count(g => g.Sport == "NFL"),
  TotalNBA = allGames.Count(g => g.Sport == "NBA"),
   TotalNASCAR = allGames.Count(g => g.Sport == "NASCAR"),
           TotalGames = allGames.Count
        };

      _recentGames = await DbContext.HistoricalGameResults
        .OrderByDescending(g => g.GameDate)
        .Take(50)
        .ToListAsync();
    }
        catch (Exception ex)
      {
            Logger.LogError(ex, "Error loading database stats");
     }
finally
        {
        _isLoadingDb = false;
     StateHasChanged();
        }
    }

    private async Task LoadTrainingStats()
    {
        try
{
       var trainingData = await DataCollectionService.GetBetsForTrainingAsync();

            _trainingStats = new TrainingStats
      {
                TotalGames = trainingData.Count,
      IsModelTrained = trainingData.Count >= 10,
         LastTrainedDate = null
       };
        }
    catch (Exception ex)
        {
       Logger.LogError(ex, "Error loading training stats");
        }
    }

    private async Task TrainModel()
    {
        try
        {
   _isTraining = true;
    _trainingResult = null;
            StateHasChanged();

  var trainingData = await DataCollectionService.GetBetsForTrainingAsync();

       if (trainingData.Count < 10)
          {
                _trainingResult = new TrainingResult
        {
         Success = false,
               Message = $"Need at least 10 games. Have {trainingData.Count}."
    };
     return;
      }

    MLModelService.TrainModel(trainingData);

            _trainingResult = new TrainingResult
    {
             Success = true,
                Message = $"Model trained with {trainingData.Count} games!"
     };

   await LoadTrainingStats();
        }
        catch (Exception ex)
 {
            Logger.LogError(ex, "Error training model");
            _trainingResult = new TrainingResult
            {
        Success = false,
           Message = $"Training failed: {ex.Message}"
   };
        }
     finally
   {
 _isTraining = false;
            StateHasChanged();
    }
    }

    private async Task ClearDatabase()
    {
        try
     {
         _isClearingDb = true;
            StateHasChanged();

    var allGames = await DbContext.HistoricalGameResults.ToListAsync();
            DbContext.HistoricalGameResults.RemoveRange(allGames);
            await DbContext.SaveChangesAsync();

            await LoadDatabaseStats();

  _fetchResult = new FetchResult
{
         Success = true,
      Message = $"Cleared {allGames.Count} games",
    Count = 0
   };
        }
        catch (Exception ex)
        {
   Logger.LogError(ex, "Error clearing database");
     _fetchResult = new FetchResult
   {
Success = false,
 Message = $"Error: {ex.Message}",
  Count = 0
        };
        }
        finally
        {
     _isClearingDb = false;
  StateHasChanged();
      }
    }

    private class FetchResult
    {
        public bool Success { get; set; }
        public string Message { get; set; } = "";
        public int Count { get; set; }
    }

    private class ImportResult
    {
     public bool Success { get; set; }
        public string Message { get; set; } = "";
    }

    private class DatabaseStats
    {
  public int TotalNFL { get; set; }
        public int TotalNBA { get; set; }
        public int TotalNASCAR { get; set; }
  public int TotalGames { get; set; }
    }

    private class TrainingStats
    {
        public int TotalGames { get; set; }
        public bool IsModelTrained { get; set; }
        public DateTime? LastTrainedDate { get; set; }
    }

    private class TrainingResult
    {
        public bool Success { get; set; }
        public string Message { get; set; } = "";
    }
}
