@using SportsBettingAnalyzer.Models
@using SportsBettingAnalyzer.Services
@using MudBlazor
@inject OddsService OddsService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        @if (_isLoading)
        {
            <div class="d-flex justify-center my-4">
                <MudProgressCircular Indeterminate="true" />
            </div>
        }
        else if (_eventData == null || !_eventData.Bookmakers.Any())
        {
            <MudAlert Severity="Severity.Warning">No player props found. They might not be available for this event or your API plan.</MudAlert>
        }
        else
        {
            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
                @{
                    // Flatten markets from all bookmakers
                    var allMarkets = _eventData.Bookmakers
                        .SelectMany(b => b.Markets.Select(m => new { Bookmaker = b.Title, Market = m }))
                        .GroupBy(x => x.Market.Key)
                        .OrderBy(g => g.Key);
                }

                @foreach (var marketGroup in allMarkets)
                {
                    <MudTabPanel Text="@FormatMarketName(marketGroup.Key)">
                        <MudTable Items="@marketGroup.SelectMany(x => x.Market.Outcomes.Select(o => new { x.Bookmaker, Outcome = o }))" Dense="true" Hover="true" Striped="true" FixedHeader="true" Height="400px">
                            <HeaderContent>
                                <MudTh>Player / Outcome</MudTh>
                                <MudTh>Point</MudTh>
                                <MudTh>Odds</MudTh>
                                <MudTh>Bookmaker</MudTh>
                            </HeaderContent>
                            <RowTemplate Context="item">
                                <MudTd>@item.Outcome.Name</MudTd>
                                <MudTd>@item.Outcome.Point</MudTd>
                                <MudTd>@FormatPrice(item.Outcome.Price)</MudTd>
                                <MudTd>@item.Bookmaker</MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudTabPanel>
                }
            </MudTabs>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public string SportKey { get; set; }
    [Parameter] public string EventId { get; set; }
    [Parameter] public string EventName { get; set; }

    private OddsEvent? _eventData;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Fetch props
            _eventData = await OddsService.GetEventOddsAsync(SportKey, EventId);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading props: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private string FormatMarketName(string key)
    {
        return System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(key.Replace("_", " "));
    }

    private string FormatPrice(double? price)
    {
        if (!price.HasValue) return "-";
        return price > 0 ? $"+{price}" : price.ToString();
    }
}
